window.addEventListener("load", init);var input;var request;function init(){document.querySelector("#results-wrap").style.display = "none";document.querySelector("#reserved-books").style.display = "none";document.querySelector("#resource-select").addEventListener("submit", submitSearch);hideResultsNav();checkBookStorage();}function checkBookStorage(){if(!"books" in localStorage){localStorage.setItem("books", "");}showBooks();}function submitSearch(evt){input = document.querySelector("#resource-search").value.trim();evt.preventDefault();request = "GET";getResource();}function getResource(){var target = document.querySelector("#result");while(target.firstChild){target.removeChild(target.lastChild);}if(input.length > 0){var url = "api.php?input=" + input;var xhttp = new XMLHttpRequest();xhttp.onreadystatechange = function(){if (xhttp.readyState === 4){if(xhttp.status === 200){jsonResults = JSON.parse(xhttp.responseText);createResults(input);showBooks();results = parseInt(jsonResults.length);events = Array.prototype.slice.call(document.querySelectorAll(".result"));numberOfPages = getNumberOfPages();showResultsNav();checkLoadList(request);}else if(xhttp.status === 204){document.querySelector("#showing-for").textContent = "No results found for '" + input + "'";hideResultsNav();}}};
xhttp.onerror = function(){hideResultsNav();alert("Error - Please check your Connection");document.querySelector("#showing-for").textContent = "No connection found";}
xhttp.open("GET", url, true);xhttp.send();}else{document.querySelector("#showing-for").textContent = "Please enter a word to search";hideResultsNav();}document.querySelector("#results-wrap").style.display = "block";}function createResults(input){document.querySelector("#showing-for").textContent = "Showing results for: '" + input + "'";var length = jsonResults.length;var target = document.querySelector("#result");for(var i = 0; i <= length - 1; i++){target.appendChild(createDiv(jsonResults[i].title,jsonResults[i].author,jsonResults[i].descr,jsonResults[i].isbn,jsonResults[i].copies,jsonResults[i].avCopies,i));}}function createDiv(title, author, descr, isbn, copies, avCopies, num){var div = document.createElement("div");var hTitle = document.createElement("h1");var hAuthor = document.createElement("h2");var pDescr = document.createElement("p");var divShow = document.createElement("div");var aShow = document.createElement("a");var divMore = document.createElement("div");var pISBN = document.createElement("p");var pCopies = document.createElement("p");var pAvCopies = document.createElement("p");var iReserve = document.createElement("input");hTitle.textContent = title;hAuthor.textContent = "by " + author;pDescr.textContent = "Description: " + descr;aShow.textContent = "More...";pISBN.textContent = "ISBN: " + isbn;pCopies.textContent = "Number of copies: " + copies;pAvCopies.textContent = "Available copies: " + avCopies;divMore.style.display = "none";iReserve.setAttribute("class", "reserve");iReserve.setAttribute("value", "Reserve");iReserve.setAttribute("type", "button");divShow.setAttribute("class", "link");aShow.setAttribute("href", "#!");aShow.setAttribute("onclick", "toggleMore(this)");divMore.setAttribute("class", "more");if(num < 5){div.setAttribute("class", "result");}else{div.setAttribute("class", "result not-visible");}iReserve.addEventListener("click", reserveItem);if(avCopies < 1){iReserve.setAttribute("disabled", "true");iReserve.style.backgroundColor = "#d8d8d8";iReserve.style.color = "#adabab";}var storedBooks = localStorage.getItem("books");if(storedBooks !== null){var booksList = storedBooks.split(",");for(var i = 0; i < booksList.length; i++){if(title === booksList[i]){iReserve.setAttribute("disabled", "true");iReserve.setAttribute("value", "Reserved");divMore.style.backgroundColor = "#e6ffe0";iReserve.style.backgroundColor = "#d8d8d8";iReserve.style.color = "#adabab";}}}div.appendChild(hTitle);div.appendChild(hAuthor);div.appendChild(pDescr);divShow.appendChild(aShow);div.appendChild(divShow);divMore.appendChild(pISBN);divMore.appendChild(pCopies);divMore.appendChild(pAvCopies);divMore.appendChild(iReserve);div.appendChild(divMore);return div;}function reserveItem(evt){evt.preventDefault();var title = this.parentElement.parentElement.children[0].textContent;var author = this.parentElement.parentElement.children[1].textContent.split("by ");var bookData = [];bookData.push(title);bookData.push(author[1]);var bookDataString = bookData.toString();var storedBooks = localStorage.getItem("books");if(storedBooks === null){localStorage.setItem("books", bookData);}else{var booksList = storedBooks.split(",");booksList.push(bookData);var newBooksList = booksList.toString();localStorage.setItem("books", newBooksList);}var avCopies = this.parentElement.children[2].textContent.split(": ");var isbn = this.parentElement.children[0].textContent.split(": ");var avCopiesInt = parseInt(avCopies[1]);var newAvCopiesInt = avCopiesInt - 1;var newAvCopies = newAvCopiesInt.toString();var data = "isbn=" + encodeURIComponent(isbn[1])+ "&avCopies=" + encodeURIComponent(newAvCopies);var url = "api.php";var xhttp = new XMLHttpRequest();xhttp.onreadystatechange = function(){if (xhttp.readyState === 4 && xhttp.status === 201){request = "POST";getResource();}};
xhttp.onerror = function() { alert("Error - Please check your Connection"); }
xhttp.open("POST", url, true);xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");xhttp.send(data);}function clearStorage(){localStorage.removeItem("books");var target = document.querySelector("#show-books");while(target.firstChild){target.removeChild(target.lastChild);}}function showBooks(){var target = document.querySelector("#show-books");while(target.firstChild){target.removeChild(target.lastChild);}var books = localStorage.getItem("books");if(books === null){var p = document.createElement("p");p.textContent = "No books reserved or on loan";target.appendChild(p);}else{var storedBooks = books.split(",");for(var i = 0; i < storedBooks.length; i++){if(i % 2){var liTitle = document.createElement("li");var ul = document.createElement("ul");var liAuthor = document.createElement("li");liTitle.textContent = storedBooks[i-1];liAuthor.textContent = "by " + storedBooks[i];ul.appendChild(liAuthor);liTitle.appendChild(ul);target.appendChild(liTitle);}}}document.querySelector("#show-books").style.display = "block";}function toggleMore(a){var extra = a.parentNode.parentNode.lastChild;if(extra.style.display === "none"){extra.style.display = "block";a.textContent = "Less...";}else{extra.style.display = "none";a.textContent = "More...";}}var pageList = new Array();var currentPage = 1;var numberPerPage = 5;var events = Array.prototype.slice.call(document.querySelectorAll(".result"));var numberOfPages = getNumberOfPages();var results;function checkLoadList(r){if(r == "GET"){loadList();}else{checkResultsNav();currentPage = 1;drawList(r);currentPage = 0;}}function getNumberOfPages(){return Math.ceil(results / numberPerPage);}function nextPage(){if(currentPage < (results/numberPerPage)){if(currentPage == 0){currentPage +=2;var remove = document.querySelector("#result").children;for (i = 0; i < 5; i++){remove[i].classList.add("not-visible");}}else{currentPage += 1;}loadList();}}function previousPage(){currentPage -= 1;loadList();}function firstPage(){currentPage = 1;loadList();}function lastPage(){if(currentPage == 0){currentPage +=2;var remove = document.querySelector("#result").children;for (i = 0; i < 5; i++){remove[i].classList.add("not-visible");}}if(currentPage < numberOfPages){currentPage = numberOfPages;loadList();}}function loadList(){var g = "GET";var begin = ((currentPage - 1) * numberPerPage);var end = begin + numberPerPage;for (i = 0; i < pageList.length; i++){pageList[i].classList.add("not-visible");}pageList = events.slice(begin, end);drawList(g);}function drawList(rr){for (i = 0; i < pageList.length; i++){pageList[i].classList.remove("not-visible");}checkResultsNav();}function checkResultsNav(){var nextElements = document.querySelectorAll(".next");for(var i = 0; i < nextElements.length; i++){nextElements[i].disabled = currentPage == numberOfPages ? true : false;if(currentPage == numberOfPages){nextElements[i].style.backgroundColor = "#d8d8d8";nextElements[i].style.color = "#adabab";}else{nextElements[i].style.backgroundColor = "#86b2f9";nextElements[i].style.color = "white";}}var previousElements = document.querySelectorAll(".previous");for(var i = 0; i < previousElements.length; i++){previousElements[i].disabled = currentPage == 1 ? true : false;if(currentPage == 1){previousElements[i].style.backgroundColor = "#d8d8d8";previousElements[i].style.color = "#adabab";}else{previousElements[i].style.backgroundColor = "#86b2f9";previousElements[i].style.color = "white";}}var firstElements = document.querySelectorAll(".first");for(var i = 0; i < firstElements.length; i++){firstElements[i].disabled = currentPage == 1 ? true : false;if(currentPage == 1){firstElements[i].style.backgroundColor = "#d8d8d8";firstElements[i].style.color = "#adabab";}else{firstElements[i].style.backgroundColor = "#86b2f9";firstElements[i].style.color = "white";}}var lastElements = document.querySelectorAll(".last");for(var i = 0; i < lastElements.length; i++){lastElements[i].disabled = currentPage == numberOfPages ? true : false;if(currentPage == numberOfPages){lastElements[i].style.backgroundColor = "#d8d8d8";lastElements[i].style.color = "#adabab";}else{lastElements[i].style.backgroundColor = "#86b2f9";lastElements[i].style.color = "white";}}}function showResultsNav(){var resultNavElements = document.querySelectorAll(".results-nav");for(var i = 0; i < resultNavElements.length; i++){resultNavElements[i].style.display = "block";}}function hideResultsNav(){var resultNavElements = document.querySelectorAll(".results-nav");for(var i = 0; i < resultNavElements.length; i++){resultNavElements[i].style.display = "none";}}function toggleReserved(){var yourResources = document.querySelector("#reserved-books");if(yourResources.style.display == "none"){document.querySelector("#reserved-books").style.display = "block";document.querySelector("#show-reserved").value = "Hide";}else{document.querySelector("#reserved-books").style.display = "none";document.querySelector("#show-reserved").value = "Show";}}